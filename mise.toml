# cfgate mise configuration

[env]
_.file = ["secrets.enc.yaml", ".env"]
IMG = "cfgate:local"
REGISTRY = "ghcr.io/inherent-design/cfgate"
CLUSTER_NAME = "abaddon"
GATEWAY_API_VERSION = "v1.4.1"

[tools]
go = "1.25"
"aqua:kubernetes-sigs/kind" = "0.31.0"
"aqua:kubernetes/kubernetes/kubectl" = "1.35.0"
"aqua:kubernetes-sigs/kustomize" = "5.8.0"
"aqua:golangci/golangci-lint" = "2.8.0"
"github:kubernetes-sigs/controller-tools[exe=controller-gen]" = "0.20.0"
"go:github.com/onsi/ginkgo/v2/ginkgo" = "2.28.1"

#
# Development
#

[tasks.codegen]
alias = ["gen"]
description = "Generate DeepCopy and CRD manifests"
run = "sh tasks/codegen.sh"

[tasks.lint]
description = "Run golangci-lint"
run = "sh tasks/lint.sh"

[tasks."lint:fix"]
alias = ["fix"]
description = "Run golangci-lint with auto-fix"
run = "LINT_FIX=1 sh tasks/lint.sh"

[tasks.format]
alias = ["fmt"]
description = "Format and vet code"
run = "sh tasks/fmt.sh"

#
# Build
#

[tasks.build]
alias = "b"
description = "Build manager binary"
depends = ["codegen"]
run = "sh tasks/build.sh"

[tasks.manifests]
alias = "dist"
description = "Generate release manifests to dist/"
depends = ["codegen"]
run = "sh tasks/manifests.sh"

#
# Testing
#

[tasks.e2e]
description = "Run E2E tests against live Cloudflare API"
env = { E2E_USE_EXISTING_CLUSTER = "true" }
run = "sh tasks/e2e.sh"

[tasks."e2e:filter"]
alias = ["fe2e"]
description = "Run E2E tests with a Ginkgo --focus filter"
usage = 'arg "filter" help="Ginkgo --focus regex"'
env = { E2E_USE_EXISTING_CLUSTER = "true" }
run = "E2E_FOCUS=\"{{arg(name='filter')}}\" sh tasks/e2e.sh"

[tasks."e2e:cleanup"]
alias = ["clean"]
description = "Clean up orphaned E2E test resources from Cloudflare"
run = "go run ./cmd/cleanup"

#
# Cluster - Local Development
#

[tasks."cluster:create"]
description = "Create dedicated cfgate dev cluster"
run = """
if kind get clusters 2>/dev/null | grep -qx "${CLUSTER_NAME}"; then
  echo "Cluster '${CLUSTER_NAME}' already exists"
else
  kind create cluster --name "${CLUSTER_NAME}" --wait 5m
fi
kubectl config use-context "kind-${CLUSTER_NAME}"
kubectl cluster-info
"""

[tasks."cluster:delete"]
description = "Delete cfgate dev cluster"
run = "kind delete cluster --name ${CLUSTER_NAME}"

[tasks."cluster:status"]
description = "Check cfgate dev cluster status"
run = "kind get clusters | grep -qx ${CLUSTER_NAME} && kubectl --context kind-${CLUSTER_NAME} get nodes || echo '${CLUSTER_NAME} cluster not found'"

#
# Deploy - Local Development
#

[tasks."local:install"]
description = "Install Gateway API and cfgate CRDs"
depends = ["codegen"]
run = """
kubectl apply -f "https://github.com/kubernetes-sigs/gateway-api/releases/download/${GATEWAY_API_VERSION}/standard-install.yaml"
kubectl apply -k config/crd
"""

[tasks."local:deploy"]
description = "Deploy controller to current cluster"
depends = ["codegen", "docker:build"]
run = """
kind load docker-image ${IMG} --name ${CLUSTER_NAME}
cd config/manager && kustomize edit set image controller=${IMG} && cd ../..
kubectl apply -k config/default
git checkout config/manager/kustomization.yaml 2>/dev/null || true
"""

[tasks."local:undeploy"]
description = "Remove controller from current cluster"
run = "kubectl delete -k config/default --ignore-not-found"

[tasks."local:uninstall"]
description = "Uninstall CRDs from current cluster"
run = """
kubectl delete -k config/crd --ignore-not-found
kubectl delete -f "https://github.com/kubernetes-sigs/gateway-api/releases/download/${GATEWAY_API_VERSION}/standard-install.yaml" --ignore-not-found 2>/dev/null || true
"""

[tasks."local:helm"]
description = "Deploy controller via local Helm chart"
depends = ["codegen", "docker:build"]
run = """
kind load docker-image ${IMG} --name ${CLUSTER_NAME}
helm upgrade --install cfgate charts/cfgate \
  --namespace cfgate-system --create-namespace \
  --set image.repository=${IMG%%:*} \
  --set image.tag=${IMG##*:} \
  --set image.pullPolicy=Never
"""

#
# Controller
#

[tasks.run]
description = "Run controller locally (outside cluster)"
run = "go run ./cmd/manager"

#
# Docker
#

[tasks."docker:build"]
alias = "db"
description = "Build Docker image"
run = "sh tasks/docker-build.sh"

[tasks."docker:push"]
alias = "dp"
description = "Push Docker image to registry"
run = """
. tasks/version.sh
if [ -n "$TAG" ] && [ "$(git describe --tags --exact-match 2>/dev/null)" = "$TAG" ]; then
  docker tag ${IMG} ${REGISTRY}:${VERSION}
  docker tag ${IMG} ${REGISTRY}:latest
  docker push ${REGISTRY}:${VERSION}
  docker push ${REGISTRY}:latest
else
  docker tag ${IMG} ${REGISTRY}:dev
  docker push ${REGISTRY}:dev
fi
"""

#
# Helm
#

[tasks."helm:lint"]
description = "Lint Helm chart"
run = "sh tasks/helm-lint.sh"

[tasks."helm:template"]
description = "Render Helm chart templates (dry run)"
run = "helm template cfgate charts/cfgate"

[tasks."docker:buildx"]
description = "Build multi-arch image (amd64 + arm64)"
run = """
. tasks/version.sh
if [ -n "$TAG" ] && [ "$(git describe --tags --exact-match 2>/dev/null)" = "$TAG" ]; then
  TAGS="-t ${REGISTRY}:${VERSION} -t ${REGISTRY}:latest"
else
  TAGS="-t ${REGISTRY}:dev"
fi
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  --build-arg VERSION="${VERSION}" \
  --build-arg COMMIT="${COMMIT}" \
  --build-arg BUILD_DATE="${BUILD_DATE}" \
  ${TAGS} \
  --push .
"""
